name: TruffleHog Secret Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  trufflehog-scan:
    name: Run TruffleHog Secret Scanner
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Run TruffleHog and generate JSON
      - name: Run TruffleHog
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            trufflesecurity/trufflehog:latest \
            git file:///repo \
            --json \
            --no-update > trufflehog.json

      # 3. Convert TruffleHog JSON â†’ SARIF using your Docker image
      - name: Convert JSON to SARIF
        run: |
          cat trufflehog.json | docker run --rm \
            narendrapalla486/trufflehog-sarif:latest \
            --input - --output - > trufflehog.sarif

      # 4. Upload SARIF to GitHub Security tab
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trufflehog.sarif

      # 5. Upload artifacts (JSON + SARIF)
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-scan-results
          path: |
            trufflehog.json
            trufflehog.sarif
